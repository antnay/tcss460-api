services:
  server:
    build:
      context: ./
      dockerfile: server/Dockerfile

    ports:
      - "${SERVER_PORT:-4000}:${SERVER_PORT:-4000}"

    volumes:
      - ./server:/server-app
      - /server-app/node_modules

    env_file:
      - path: ./server/.env
        required: true

    environment:
      NODE_ENV: ${NODE_ENV:-development}
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_NAME: ${DB_NAME}
      DB_URL: ${DB_URL}
      REFRESH_SECRET: ${REFRESH_SECRET}
      ACCESS_SECRET: ${ACCESS_SECRET}


    command: >
      sh -c "if [ \"$NODE_ENV\" = 'production' ]; then
        echo 'Starting production server';
        npm run start;
      else
        echo 'Starting development server with hot reload';
        npm run dev;
      fi"
